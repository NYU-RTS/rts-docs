<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-hpc/ml_ai_hpc/pytorch_on_hpc_mulit_gpu" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.1">
<title data-rh="true">Multi-GPU Training with PyTorch: Distributed Data Parallel (DDP) | Connecting researchers to computational resources.</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://services.rt.nyu.edu/pr-preview/pr-193/img/NYU.svg"><meta data-rh="true" name="twitter:image" content="https://services.rt.nyu.edu/pr-preview/pr-193/img/NYU.svg"><meta data-rh="true" property="og:url" content="https://services.rt.nyu.edu/pr-preview/pr-193/docs/hpc/ml_ai_hpc/pytorch_on_hpc_mulit_gpu/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Multi-GPU Training with PyTorch: Distributed Data Parallel (DDP) | Connecting researchers to computational resources."><meta data-rh="true" name="description" content="This was adapted from Princeton University Multi-GPU Training with PyTorch"><meta data-rh="true" property="og:description" content="This was adapted from Princeton University Multi-GPU Training with PyTorch"><link data-rh="true" rel="icon" href="/pr-preview/pr-193/img/NYU.ico"><link data-rh="true" rel="canonical" href="https://services.rt.nyu.edu/pr-preview/pr-193/docs/hpc/ml_ai_hpc/pytorch_on_hpc_mulit_gpu/"><link data-rh="true" rel="alternate" href="https://services.rt.nyu.edu/pr-preview/pr-193/docs/hpc/ml_ai_hpc/pytorch_on_hpc_mulit_gpu/" hreflang="en"><link data-rh="true" rel="alternate" href="https://services.rt.nyu.edu/pr-preview/pr-193/docs/hpc/ml_ai_hpc/pytorch_on_hpc_mulit_gpu/" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Multi-GPU Training with PyTorch: Distributed Data Parallel (DDP)","item":"https://services.rt.nyu.edu/pr-preview/pr-193/docs/hpc/ml_ai_hpc/pytorch_on_hpc_mulit_gpu"}]}</script><link rel="alternate" type="application/rss+xml" href="/pr-preview/pr-193/blog/rss.xml" title="Connecting researchers to computational resources. RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/pr-preview/pr-193/blog/atom.xml" title="Connecting researchers to computational resources. Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-2DXB3BDH70"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-2DXB3BDH70",{anonymize_ip:!0})</script><link rel="stylesheet" href="/pr-preview/pr-193/assets/css/styles.f70cced0.css">
<script src="/pr-preview/pr-193/assets/js/runtime~main.cc45b575.js" defer="defer"></script>
<script src="/pr-preview/pr-193/assets/js/main.98d31f6d.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||"light"),document.documentElement.setAttribute("data-theme-choice",t||"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/pr-preview/pr-193/img/NYU.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_bHSa" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/pr-preview/pr-193/"><div class="navbar__logo"><img src="/pr-preview/pr-193/img/NYU.svg" alt="NYU torch logo" class="themedComponent_ypQ_ themedComponent--light_qQSo"><img src="/pr-preview/pr-193/img/NYU.svg" alt="NYU torch logo" class="themedComponent_ypQ_ themedComponent--dark_m0FH"></div><b class="navbar__title text--truncate">Research Technology Services</b></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/pr-preview/pr-193/docs/genai/getting_started/intro/">Pythia</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/pr-preview/pr-193/docs/hpc/getting_started/intro/">HPC</a><a class="navbar__item navbar__link" href="/pr-preview/pr-193/docs/cloud/getting_started/intro/">Cloud</a><a class="navbar__item navbar__link" href="/pr-preview/pr-193/docs/srde/getting_started/intro/">SRDE</a><a href="https://hsrn.nyu.edu/docs/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">HSRN<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_i9eD"><use href="#theme-svg-external-link"></use></svg></a><a class="navbar__item navbar__link" href="/pr-preview/pr-193/blog/">Announcements</a><div class="toggle_QBuD colorModeToggle_y_72"><button class="clean-btn toggleButton_lwp1 toggleButtonDisabled_HT4F" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_Djgd lightToggleIcon_DYGl"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_Djgd darkToggleIcon_IJRp"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_Djgd systemToggleIcon_dFXK"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_ASv1"><div class="navbar__search"><span aria-label="expand searchbar" role="button" class="search-icon" tabindex="0"></span><input id="search_input_react" type="search" placeholder="Loading..." aria-label="Search" class="navbar__search-input search-bar" disabled=""></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_zMx_"><div class="docsWrapper_vlUk"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_nMwe" type="button"></button><div class="docRoot_wnou"><aside class="theme-doc-sidebar-container docSidebarContainer_JrTY"><div class="sidebarViewport_wVN_"><div class="sidebar_Zo3G"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_XvAV"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_OTIz menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/pr-preview/pr-193/docs/hpc/getting_started/intro/"><span title="Getting Started" class="categoryLinkLabel_IRz3">Getting Started</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_OTIz menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/pr-preview/pr-193/docs/hpc/connecting_to_hpc/connecting_to_hpc/"><span title="Setup" class="categoryLinkLabel_IRz3">Setup</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_OTIz menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/pr-preview/pr-193/docs/hpc/storage/intro_and_data_management/"><span title="Storage &amp; Data transfers" class="categoryLinkLabel_IRz3">Storage &amp; Data transfers</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_OTIz menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/pr-preview/pr-193/docs/hpc/datasets/intro/"><span title="Datasets" class="categoryLinkLabel_IRz3">Datasets</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_OTIz menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/pr-preview/pr-193/docs/hpc/submitting_jobs/slurm_submitting_jobs/"><span title="Submitting jobs" class="categoryLinkLabel_IRz3">Submitting jobs</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_OTIz menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/pr-preview/pr-193/docs/hpc/tools_and_software/intro/"><span title="Tools &amp; Software" class="categoryLinkLabel_IRz3">Tools &amp; Software</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_OTIz menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/pr-preview/pr-193/docs/hpc/containers/intro/"><span title="Containers" class="categoryLinkLabel_IRz3">Containers</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_OTIz menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/pr-preview/pr-193/docs/hpc/ml_ai_hpc/intro/"><span title="ML/AI on HPC" class="categoryLinkLabel_IRz3">ML/AI on HPC</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/pr-preview/pr-193/docs/hpc/ml_ai_hpc/intro/"><span title="Machine Learning on HPC" class="linkLabel_RgMO">Machine Learning on HPC</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/pr-preview/pr-193/docs/hpc/ml_ai_hpc/pytorch_intro/"><span title="Machine Learning on HPC" class="linkLabel_RgMO">Machine Learning on HPC</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/pr-preview/pr-193/docs/hpc/ml_ai_hpc/pytorch_on_hpc_mulit_gpu/"><span title="Multi-GPU Training with PyTorch: Distributed Data Parallel (DDP)" class="linkLabel_RgMO">Multi-GPU Training with PyTorch: Distributed Data Parallel (DDP)</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/pr-preview/pr-193/docs/hpc/ml_ai_hpc/run_hf_model/"><span title="Run a Hugging Face model" class="linkLabel_RgMO">Run a Hugging Face model</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/pr-preview/pr-193/docs/hpc/ml_ai_hpc/llm_fine_tuning/"><span title="Fine tune LLMs on HPC" class="linkLabel_RgMO">Fine tune LLMs on HPC</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_OTIz menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/pr-preview/pr-193/docs/hpc/ood/ood_intro/"><span title="Open OnDemand (OOD)" class="categoryLinkLabel_IRz3">Open OnDemand (OOD)</span></a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/pr-preview/pr-193/docs/hpc/spec_sheet/"><span title="Torch Spec Sheet" class="linkLabel_RgMO">Torch Spec Sheet</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/pr-preview/pr-193/docs/hpc/system_status/"><span title="Greene System Status" class="linkLabel_RgMO">Greene System Status</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_OTIz menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/pr-preview/pr-193/docs/hpc/tutorial_intro_shell_hpc/intro/"><span title="Tutorial: Intro to Shell for HPC" class="categoryLinkLabel_IRz3">Tutorial: Intro to Shell for HPC</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_OTIz menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/pr-preview/pr-193/docs/hpc/tutorial_intro_hpc/intro_hpc/"><span title="Tutorial: Intro to HPC" class="categoryLinkLabel_IRz3">Tutorial: Intro to HPC</span></a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_OTIz menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/pr-preview/pr-193/docs/hpc/support/support/"><span title="Support" class="categoryLinkLabel_IRz3">Support</span></a></div></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_KK_H"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_K3iM"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_p7J4"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol__lxn"><div class="docItemContainer_T58M"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_mYRa" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/pr-preview/pr-193/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_einq"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">ML/AI on HPC</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Multi-GPU Training with PyTorch: Distributed Data Parallel (DDP)</span></li></ul></nav><div class="tocCollapsible_FsOG theme-doc-toc-mobile tocMobile_e85Q"><button type="button" class="clean-btn tocCollapsibleButton_R0hy">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Multi-GPU Training with PyTorch: Distributed Data Parallel (DDP)</h1></header>
<div class="theme-admonition theme-admonition-info admonition_aeex alert alert--info"><div class="admonitionHeading_LV_G"><span class="admonitionIcon_nEU7"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_vzt9"><p>This was adapted from <a href="https://github.com/PrincetonUniversity/multi_gpu_training" target="_blank" rel="noopener noreferrer">Princeton University Multi-GPU Training with PyTorch</a></p></div></div>
<p>One should always first try to use only a single GPU for training. This maximizes efficiency. There are two common reasons for using multiple GPUs when training neural networks:</p>
<ul>
<li>the execution time is too long with a single GPU</li>
<li>the model is too large to fit on a single GPU</li>
</ul>
<div class="theme-admonition theme-admonition-tip admonition_aeex alert alert--success"><div class="admonitionHeading_LV_G"><span class="admonitionIcon_nEU7"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_vzt9"><p>The more GPUs you request for a Slurm job, the longer the queue time will be. Learn how to conduct a <a href="https://researchcomputing.princeton.edu/support/knowledge-base/scaling-analysis" target="_blank" rel="noopener noreferrer">scaling analysis</a> to find the optimal number of GPUs.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_nzaP" id="overall-idea-of-distributed-data-parallel">Overall Idea of Distributed Data Parallel<a href="#overall-idea-of-distributed-data-parallel" class="hash-link" aria-label="Direct link to Overall Idea of Distributed Data Parallel" title="Direct link to Overall Idea of Distributed Data Parallel" translate="no">​</a></h2>
<p>The single-program, multiple data (SPMD) paradigm is used. That is, the model is copied to each of the GPUs. The input data is divided between the GPUs evenly. After the gradients have been computed they are averaged across all the GPUs. This is done in a way that all replicas have numerically identical values for the average gradients. The weights are then updated and once again they are identical by construction. The process then repeats with new mini-batches sent to the GPUs.</p>
<p><img decoding="async" loading="lazy" src="https://www.telesens.co/wp-content/uploads/2019/04/img_5ca570946ee1c.png" alt="ddp" class="img_mZZa"></p>
<p><em>Credit for the image above is <a href="https://www.telesens.co/wp-content/uploads/2019/04/img_5ca570946ee1c.png" target="_blank" rel="noopener noreferrer">here</a>.</em></p>
<p>If you would like more background then read through these PyTorch pages:</p>
<ul>
<li><a href="https://pytorch.org/tutorials/intermediate/ddp_tutorial.html" target="_blank" rel="noopener noreferrer">Getting Started with Distributed Data Parallel</a></li>
<li><a href="https://pytorch.org/docs/stable/generated/torch.nn.parallel.DistributedDataParallel.html" target="_blank" rel="noopener noreferrer">See the docs on DPP</a></li>
</ul>
<p>Here are some webpages and videos:</p>
<ul>
<li><a href="https://www.youtube.com/watch?v=TibQO_xv1zc" target="_blank" rel="noopener noreferrer">YouTube Video</a></li>
<li><a href="https://gist.github.com/TengdaHan/1dd10d335c7ca6f13810fff41e809904" target="_blank" rel="noopener noreferrer">GitHub Gist</a></li>
<li><a href="https://info.gwdg.de/wiki/doku.php?id=wiki:hpc:pytorch_on_the_hpc_clusters" target="_blank" rel="noopener noreferrer">GWDG Webpage</a></li>
<li><a href="https://sagemaker.readthedocs.io/en/stable/api/training/sdp_versions/latestsmd_data_parallel_pytorch.html" target="_blank" rel="noopener noreferrer">SageMaker Webpage</a></li>
</ul>
<div class="theme-admonition theme-admonition-warning admonition_aeex alert alert--warning"><div class="admonitionHeading_LV_G"><span class="admonitionIcon_nEU7"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_vzt9"><p>Do not use <code>DataParallel</code> in PyTorch for anything since it gives poor performance relative to <code>DistributedDataParallel</code>.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_nzaP" id="main-changes-needed-in-going-from-single-gpu-to-multi-gpu-training-with-ddp">Main changes needed in going from single-GPU to multi-GPU training with DDP<a href="#main-changes-needed-in-going-from-single-gpu-to-multi-gpu-training-with-ddp" class="hash-link" aria-label="Direct link to Main changes needed in going from single-GPU to multi-GPU training with DDP" title="Direct link to Main changes needed in going from single-GPU to multi-GPU training with DDP" translate="no">​</a></h2>
<p>This completely new piece is needed to form the process group:</p>
<div class="language-python codeBlockContainer_Gtvh theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_q3dc"><pre tabindex="0" class="prism-code language-python codeBlock_ggay thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_Y19p"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token keyword" style="color:hsl(301, 63%, 40%)">def</span><span class="token plain"> </span><span class="token function" style="color:hsl(221, 87%, 60%)">setup</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">rank</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> world_size</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token comment" style="color:hsl(230, 4%, 64%)"># initialize the process group</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    dist</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">init_process_group</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;nccl&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> rank</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain">rank</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> world_size</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain">world_size</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><br></span></code></pre></div></div>
<p>Note that <code>dist.init_process_group()</code> is blocking. That means the code waits until all processes have reached that line and the command is successfully executed before going on. One should prefer <code>nccl</code> over <code>gloo</code> since the latter will use TCP by first moving tensor to CPU.</p>
<p>For the single-GPU training:</p>
<div class="language-python codeBlockContainer_Gtvh theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_q3dc"><pre tabindex="0" class="prism-code language-python codeBlock_ggay thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_Y19p"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">model </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> Net</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">to</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">device</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">optimizer </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> optim</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">Adadelta</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">model</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">parameters</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> lr</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain">args</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">lr</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><br></span></code></pre></div></div>
<p>For multi-GPU training with DPP:</p>
<div class="language-python codeBlockContainer_Gtvh theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_q3dc"><pre tabindex="0" class="prism-code language-python codeBlock_ggay thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_Y19p"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">model </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> Net</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">to</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">local_rank</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">ddp_model </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> DDP</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">model</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> device_ids</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token plain">local_rank</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">optimizer </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> optim</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">Adadelta</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">ddp_model</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">parameters</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> lr</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain">args</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">lr</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><br></span></code></pre></div></div>
<p>More on <code>local_rank</code> below. In short, this is the GPU index.</p>
<p>One also needs to ensure that a different batch is sent to each GPU:</p>
<div class="language-text codeBlockContainer_Gtvh theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_q3dc"><pre tabindex="0" class="prism-code language-text codeBlock_ggay thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_Y19p"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">train_sampler = torch.utils.data.distributed.DistributedSampler(dataset1, num_replicas=world_size, rank=rank)</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    train_loader = torch.utils.data.DataLoader(dataset1, batch_size=args.batch_size, sampler=train_sampler, \</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                                               num_workers=int(os.environ[&quot;SLURM_CPUS_PER_TASK&quot;]), pin_memory=True)</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_nzaP" id="simple-ddp-script">Simple DDP Script<a href="#simple-ddp-script" class="hash-link" aria-label="Direct link to Simple DDP Script" title="Direct link to Simple DDP Script" translate="no">​</a></h2>
<p>The following can be used as a simple use case of DPP:</p>
<div class="language-python codeBlockContainer_Gtvh theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_q3dc"><pre tabindex="0" class="prism-code language-python codeBlock_ggay thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_Y19p"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token keyword" style="color:hsl(301, 63%, 40%)">import</span><span class="token plain"> os</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">import</span><span class="token plain"> torch</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">import</span><span class="token plain"> torch</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">nn </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">as</span><span class="token plain"> nn</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">import</span><span class="token plain"> torch</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">nn</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">functional </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">as</span><span class="token plain"> F</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">import</span><span class="token plain"> torch</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">distributed </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">as</span><span class="token plain"> dist</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">from</span><span class="token plain"> torch</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">nn</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">parallel </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">import</span><span class="token plain"> DistributedDataParallel </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">as</span><span class="token plain"> DDP</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">from</span><span class="token plain"> socket </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">import</span><span class="token plain"> gethostname</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">class</span><span class="token plain"> </span><span class="token class-name" style="color:hsl(35, 99%, 36%)">Net</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">nn</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">Module</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">def</span><span class="token plain"> </span><span class="token function" style="color:hsl(221, 87%, 60%)">__init__</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">super</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">Net</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> self</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">__init__</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        self</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">fc </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> nn</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">Linear</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token number" style="color:hsl(35, 99%, 36%)">42</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">3</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">def</span><span class="token plain"> </span><span class="token function" style="color:hsl(221, 87%, 60%)">forward</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> x</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        x </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">fc</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">x</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        x </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> F</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">relu</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">x</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        output </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> F</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">log_softmax</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">x</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> dim</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token number" style="color:hsl(35, 99%, 36%)">1</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">return</span><span class="token plain"> output</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">rank          </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">int</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">os</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;SLURM_PROCID&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">world_size    </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">int</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">os</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;WORLD_SIZE&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">gpus_per_node </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">int</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">os</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;SLURM_GPUS_ON_NODE&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">assert</span><span class="token plain"> gpus_per_node </span><span class="token operator" style="color:hsl(221, 87%, 60%)">==</span><span class="token plain"> torch</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">cuda</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">device_count</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">print</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">f&quot;Hello from rank </span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">{</span><span class="token string-interpolation interpolation">rank</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">}</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)"> of </span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">{</span><span class="token string-interpolation interpolation">world_size</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">}</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)"> on </span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">{</span><span class="token string-interpolation interpolation">gethostname</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">}</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)"> where there are&quot;</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">      </span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">f&quot; </span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">{</span><span class="token string-interpolation interpolation">gpus_per_node</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">}</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)"> allocated GPUs per node.&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> flush</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token boolean" style="color:hsl(35, 99%, 36%)">True</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">dist</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">init_process_group</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;nccl&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> rank</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain">rank</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> world_size</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain">world_size</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">if</span><span class="token plain"> rank </span><span class="token operator" style="color:hsl(221, 87%, 60%)">==</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">0</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">print</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">f&quot;Group initialized? </span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">{</span><span class="token string-interpolation interpolation">dist</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token string-interpolation interpolation">is_initialized</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">}</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> flush</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token boolean" style="color:hsl(35, 99%, 36%)">True</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local_rank </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> rank </span><span class="token operator" style="color:hsl(221, 87%, 60%)">-</span><span class="token plain"> gpus_per_node </span><span class="token operator" style="color:hsl(221, 87%, 60%)">*</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">rank </span><span class="token operator" style="color:hsl(221, 87%, 60%)">//</span><span class="token plain"> gpus_per_node</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">torch</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">cuda</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">set_device</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">local_rank</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">model </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> Net</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">to</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">local_rank</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">ddp_model </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> DDP</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">model</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> device_ids</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token plain">local_rank</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">ddp_model</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token builtin" style="color:hsl(119, 34%, 47%)">eval</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">with</span><span class="token plain"> torch</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">no_grad</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  data </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">rand</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token number" style="color:hsl(35, 99%, 36%)">1</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">42</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  data </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> data</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">to</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">local_rank</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  output </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> ddp_model</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">data</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">  </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">print</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">f&quot;host: </span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">{</span><span class="token string-interpolation interpolation">gethostname</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">}</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">, rank: </span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">{</span><span class="token string-interpolation interpolation">rank</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">}</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">, output: </span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">{</span><span class="token string-interpolation interpolation">output</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">}</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">dist</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">destroy_process_group</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><br></span></code></pre></div></div>
<p><code>SLURM_PROCID</code> is a Slurm environment variable and it varies from 0 to N - 1, where N is the number of tasks running under <code>srun</code>.  For instance, consider the abbreviated Slurm script below:</p>
<div class="language-text codeBlockContainer_Gtvh theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_q3dc"><pre tabindex="0" class="prism-code language-text codeBlock_ggay thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_Y19p"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">#SBATCH --nodes=2</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">#SBATCH --ntasks-per-node=4</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">...</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">srun python myscript.py</span><br></span></code></pre></div></div>
<p>The Python interpreter will be launched 8 times (2 x 4) and each of the 8 tasks will have a different value of <code>SLURM_PROCID</code> from
the set 0, 1, 2, 3, 4, 5, 6, 7.</p>
<p>Below is a full Slurm script for using DDP for Della (GPU) where there are 2 GPUs per node:</p>
<p><strong>run-full.SBATCH:</strong></p>
<div class="language-bash codeBlockContainer_Gtvh theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_q3dc"><pre tabindex="0" class="prism-code language-bash codeBlock_ggay thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_Y19p"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token shebang important" style="color:hsl(230, 8%, 24%);font-weight:bold">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)">#SBATCH --nodes=2</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)">#SBATCH --ntasks-per-node=2</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)">#SBATCH --time=1:00:00</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)">#SBATCH --mem=2GB</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)">#SBATCH --gres=gpu:2</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)">#SBATCH --job-name=torch</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">module purge</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token builtin class-name" style="color:hsl(35, 99%, 36%)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:hsl(221, 87%, 60%)">MASTER_ADDR</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token variable" style="color:hsl(221, 87%, 60%)">$(</span><span class="token variable function" style="color:hsl(221, 87%, 60%)">hostname</span><span class="token variable" style="color:hsl(221, 87%, 60%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token builtin class-name" style="color:hsl(35, 99%, 36%)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:hsl(221, 87%, 60%)">MASTER_PORT</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token number" style="color:hsl(35, 99%, 36%)">12345</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token builtin class-name" style="color:hsl(35, 99%, 36%)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:hsl(221, 87%, 60%)">WORLD_SIZE</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token variable" style="color:hsl(221, 87%, 60%)">$SLURM_NTASKS</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token builtin class-name" style="color:hsl(35, 99%, 36%)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:hsl(221, 87%, 60%)">RANK</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token variable" style="color:hsl(221, 87%, 60%)">$SLURM_PROCID</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">srun singularity </span><span class="token builtin class-name" style="color:hsl(35, 99%, 36%)">exec</span><span class="token plain"> </span><span class="token parameter variable" style="color:hsl(221, 87%, 60%)">--nv</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	    </span><span class="token parameter variable" style="color:hsl(221, 87%, 60%)">--overlay</span><span class="token plain"> /scratch/NetID/pytorch-example/my_pytorch.ext3:ro </span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	    /scratch/work/public/singularity/cuda12.1.1-cudnn8.9.0-devel-ubuntu22.04.2.sif</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	    /bin/bash </span><span class="token parameter variable" style="color:hsl(221, 87%, 60%)">-c</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;source /ext3/env.sh; python simple_ddp.py&quot;</span><br></span></code></pre></div></div>
<p>In the script above, <code>MASTER_PORT</code>, <code>MASTER_ADDR</code> and <code>WORLD_SIZE</code> are set. The three are later used to create the DDP process group. The total number of GPUs allocated to the job must be equal to <code>WORLD_SIZE</code> -- this is satisfied above since nodes times ntasks-per-node is <code>2 x 2 = 4</code> and number of GPUs allocated is nodes times gpus_per_node which is also <code>2 x 2 = 4</code>.</p>
<p>This uses the overlay file for PyTorch we created in <a href="/pr-preview/pr-193/docs/hpc/containers/singularity_with_conda/">Singularity with Conda</a></p>
<h3 class="anchor anchorWithStickyNavbar_nzaP" id="job-arrays">Job Arrays<a href="#job-arrays" class="hash-link" aria-label="Direct link to Job Arrays" title="Direct link to Job Arrays" translate="no">​</a></h3>
<p>For a job array, all jobs of the array have the same value of <code>SLURM_JOBID</code>. Because of this, it is wise to modify <code>MASTER_PORT</code>.
Here is one possibility:</p>
<div class="language-text codeBlockContainer_Gtvh theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_q3dc"><pre tabindex="0" class="prism-code language-text codeBlock_ggay thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_Y19p"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">export MASTER_PORT=$(expr 10000 + $(echo -n $SLURM_JOBID | tail -c 4) + $SLURM_ARRAY_TASK_ID)</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_nzaP" id="--ntasks-per-node-versus---ntasks">--ntasks-per-node versus --ntasks<a href="#--ntasks-per-node-versus---ntasks" class="hash-link" aria-label="Direct link to --ntasks-per-node versus --ntasks" title="Direct link to --ntasks-per-node versus --ntasks" translate="no">​</a></h3>
<p>Be sure to use <code>--ntasks-per-node</code> and not <code>--ntasks</code> in your Slurm script.</p>
<h2 class="anchor anchorWithStickyNavbar_nzaP" id="what-is-local_rank">What is <code>local_rank</code>?<a href="#what-is-local_rank" class="hash-link" aria-label="Direct link to what-is-local_rank" title="Direct link to what-is-local_rank" translate="no">​</a></h2>
<p>The indices of the GPUs on each node of your Slurm allocation begin at 0 and end at N - 1, where N is the total number of GPUs in your allocation on each node. Consider the case of 2 nodes and 8 tasks with 4 GPUs per node. The process ranks will be 0, 1, 2, 3 on the first node and 4, 5, 6, 7 on the second node while the GPU indices will be 0, 1, 2, 3 on the first and 0, 1, 2, 3 on the second. Thus, one cannot make calls such as <code>data.to(rank)</code> since this will fail on the second node where there is a mismatch between the process ranks and the GPU indices. To deal with this a local rank is introduced:</p>
<div class="language-python codeBlockContainer_Gtvh theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_q3dc"><pre tabindex="0" class="prism-code language-python codeBlock_ggay thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_Y19p"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">rank </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">int</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">os</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;SLURM_PROCID&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">gpus_per_node </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">int</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">os</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;SLURM_GPUS_ON_NODE&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">local_rank </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> rank </span><span class="token operator" style="color:hsl(221, 87%, 60%)">-</span><span class="token plain"> gpus_per_node </span><span class="token operator" style="color:hsl(221, 87%, 60%)">*</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">rank </span><span class="token operator" style="color:hsl(221, 87%, 60%)">//</span><span class="token plain"> gpus_per_node</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><br></span></code></pre></div></div>
<p>The <code>local_rank</code> should be used everywhere in your script except when initializing the DDP process group where <code>rank</code> should be used. In Python, one uses the  <code>//</code> operator for integer division. For example, <code>1 / 2 = 0.5</code> while <code>1 // 2 = 0</code>.</p>
<h1>DDP and Slurm</h1>
<h2 class="anchor anchorWithStickyNavbar_nzaP" id="total-number-of-tasks-equals-total-number-of-gpus">Total number of tasks equals total number of GPUs<a href="#total-number-of-tasks-equals-total-number-of-gpus" class="hash-link" aria-label="Direct link to Total number of tasks equals total number of GPUs" title="Direct link to Total number of tasks equals total number of GPUs" translate="no">​</a></h2>
<p>When using DDP, the total number of tasks must equal the total number of allocated GPUs. Therefore, if <code>--ntasks-per-node=&lt;N&gt;</code> then you must have <code>--gres=gpu:&lt;N&gt;</code>. Here are two examples:</p>
<div class="language-text codeBlockContainer_Gtvh theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_q3dc"><pre tabindex="0" class="prism-code language-text codeBlock_ggay thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_Y19p"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">#SBATCH --ntasks-per-node=2</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">#SBATCH --gres=gpu:2</span><br></span></code></pre></div></div>
<div class="language-text codeBlockContainer_Gtvh theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_q3dc"><pre tabindex="0" class="prism-code language-text codeBlock_ggay thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_Y19p"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">#SBATCH --ntasks-per-node=4</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">#SBATCH --gres=gpu:4</span><br></span></code></pre></div></div>
<p>You should take all of the GPUs on a node before going to multiple nodes. Never do one GPU per node for multinode jobs.</p>
<h2 class="anchor anchorWithStickyNavbar_nzaP" id="full-example-of-ddp">Full Example of DDP<a href="#full-example-of-ddp" class="hash-link" aria-label="Direct link to Full Example of DDP" title="Direct link to Full Example of DDP" translate="no">​</a></h2>
<p>Below is an example Slurm script for DDP:</p>
<div class="language-bash codeBlockContainer_Gtvh theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_q3dc"><pre tabindex="0" class="prism-code language-bash codeBlock_ggay thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_Y19p"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token shebang important" style="color:hsl(230, 8%, 24%);font-weight:bold">#!/bin/bash</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)">#SBATCH --job-name=ddp-torch     # create a short name for your job</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)">#SBATCH --nodes=2                # node count</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)">#SBATCH --ntasks-per-node=2      # total number of tasks per node</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)">#SBATCH --cpus-per-task=8        # cpu-cores per task (&gt;1 if multi-threaded tasks)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)">#SBATCH --mem=32G                # total memory per node (4 GB per cpu-core is default)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)">#SBATCH --gres=gpu:2             # number of gpus per node</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)">#SBATCH --time=00:05:00          # total run time limit (HH:MM:SS)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token builtin class-name" style="color:hsl(35, 99%, 36%)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:hsl(221, 87%, 60%)">MASTER_PORT</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token variable" style="color:hsl(221, 87%, 60%)">$(</span><span class="token variable function" style="color:hsl(221, 87%, 60%)">expr</span><span class="token variable" style="color:hsl(221, 87%, 60%)"> </span><span class="token variable number" style="color:hsl(35, 99%, 36%)">10000</span><span class="token variable" style="color:hsl(221, 87%, 60%)"> + </span><span class="token variable punctuation" style="color:hsl(119, 34%, 47%)">$(</span><span class="token variable" style="color:hsl(221, 87%, 60%)">echo </span><span class="token variable parameter variable" style="color:hsl(221, 87%, 60%)">-n</span><span class="token variable" style="color:hsl(221, 87%, 60%)"> $SLURM_JOBID </span><span class="token variable operator" style="color:hsl(221, 87%, 60%)">|</span><span class="token variable" style="color:hsl(221, 87%, 60%)"> </span><span class="token variable function" style="color:hsl(221, 87%, 60%)">tail</span><span class="token variable" style="color:hsl(221, 87%, 60%)"> </span><span class="token variable parameter variable" style="color:hsl(221, 87%, 60%)">-c</span><span class="token variable" style="color:hsl(221, 87%, 60%)"> </span><span class="token variable number" style="color:hsl(35, 99%, 36%)">4</span><span class="token variable punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token variable" style="color:hsl(221, 87%, 60%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token builtin class-name" style="color:hsl(35, 99%, 36%)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:hsl(221, 87%, 60%)">WORLD_SIZE</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token variable" style="color:hsl(221, 87%, 60%)">$((</span><span class="token variable" style="color:hsl(221, 87%, 60%)">$SLURM_NNODES </span><span class="token variable operator" style="color:hsl(221, 87%, 60%)">*</span><span class="token variable" style="color:hsl(221, 87%, 60%)"> $SLURM_NTASKS_PER_NODE</span><span class="token variable" style="color:hsl(221, 87%, 60%)">))</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token builtin class-name" style="color:hsl(35, 99%, 36%)">echo</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;WORLD_SIZE=&quot;</span><span class="token variable" style="color:hsl(221, 87%, 60%)">$WORLD_SIZE</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token assign-left variable" style="color:hsl(221, 87%, 60%)">master_addr</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token variable" style="color:hsl(221, 87%, 60%)">$(</span><span class="token variable" style="color:hsl(221, 87%, 60%)">scontrol show hostnames </span><span class="token variable string" style="color:hsl(119, 34%, 47%)">&quot;</span><span class="token variable string variable" style="color:hsl(221, 87%, 60%)">$SLURM_JOB_NODELIST</span><span class="token variable string" style="color:hsl(119, 34%, 47%)">&quot;</span><span class="token variable" style="color:hsl(221, 87%, 60%)"> </span><span class="token variable operator" style="color:hsl(221, 87%, 60%)">|</span><span class="token variable" style="color:hsl(221, 87%, 60%)"> </span><span class="token variable function" style="color:hsl(221, 87%, 60%)">head</span><span class="token variable" style="color:hsl(221, 87%, 60%)"> </span><span class="token variable parameter variable" style="color:hsl(221, 87%, 60%)">-n</span><span class="token variable" style="color:hsl(221, 87%, 60%)"> </span><span class="token variable number" style="color:hsl(35, 99%, 36%)">1</span><span class="token variable" style="color:hsl(221, 87%, 60%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token builtin class-name" style="color:hsl(35, 99%, 36%)">export</span><span class="token plain"> </span><span class="token assign-left variable" style="color:hsl(221, 87%, 60%)">MASTER_ADDR</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token variable" style="color:hsl(221, 87%, 60%)">$master_addr</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token builtin class-name" style="color:hsl(35, 99%, 36%)">echo</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;MASTER_ADDR=&quot;</span><span class="token variable" style="color:hsl(221, 87%, 60%)">$MASTER_ADDR</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">srun singularity </span><span class="token builtin class-name" style="color:hsl(35, 99%, 36%)">exec</span><span class="token plain"> </span><span class="token parameter variable" style="color:hsl(221, 87%, 60%)">--nv</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	    </span><span class="token parameter variable" style="color:hsl(221, 87%, 60%)">--overlay</span><span class="token plain"> /scratch/NetID/pytorch-example/my_pytorch.ext3:ro </span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	    /scratch/work/public/singularity/cuda12.1.1-cudnn8.9.0-devel-ubuntu22.04.2.sif</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">	    /bin/bash </span><span class="token parameter variable" style="color:hsl(221, 87%, 60%)">-c</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;source /ext3/env.sh; python download_data.py; python mnist_classify_ddp.py --epoch</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token string" style="color:hsl(119, 34%, 47%)">s=2&quot;</span><br></span></code></pre></div></div>
<p>The script above uses 2 nodes with 2 tasks per node and therefore 2 GPUs per node. This yields a total of 4 processes and each process can use 8 CPU-cores for data loading. An allocation of 4 GPUs is substantial so the queue time may be long. In all cases make sure that the GPUs are being used efficiently by monitoring the <a href="https://researchcomputing.princeton.edu/support/knowledge-base/gpu-computing" target="_blank" rel="noopener noreferrer">GPU utilization</a>.</p>
<p>Below is the original single-GPU Python script modified to use DDP:</p>
<div class="language-python codeBlockContainer_Gtvh theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_q3dc"><pre tabindex="0" class="prism-code language-python codeBlock_ggay thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_Y19p"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token keyword" style="color:hsl(301, 63%, 40%)">import</span><span class="token plain"> argparse</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">import</span><span class="token plain"> torch</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">import</span><span class="token plain"> torch</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">nn </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">as</span><span class="token plain"> nn</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">import</span><span class="token plain"> torch</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">nn</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">functional </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">as</span><span class="token plain"> F</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">import</span><span class="token plain"> torch</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">optim </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">as</span><span class="token plain"> optim</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">from</span><span class="token plain"> torchvision </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">import</span><span class="token plain"> datasets</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> transforms</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">from</span><span class="token plain"> torch</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">optim</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">lr_scheduler </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">import</span><span class="token plain"> StepLR</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">import</span><span class="token plain"> os</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">import</span><span class="token plain"> torch</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">distributed </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">as</span><span class="token plain"> dist</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">from</span><span class="token plain"> torch</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">nn</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">parallel </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">import</span><span class="token plain"> DistributedDataParallel </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">as</span><span class="token plain"> DDP</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">from</span><span class="token plain"> socket </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">import</span><span class="token plain"> gethostname</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">class</span><span class="token plain"> </span><span class="token class-name" style="color:hsl(35, 99%, 36%)">Net</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">nn</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">Module</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">def</span><span class="token plain"> </span><span class="token function" style="color:hsl(221, 87%, 60%)">__init__</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">super</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">Net</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> self</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">__init__</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        self</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">conv1 </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> nn</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">Conv2d</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token number" style="color:hsl(35, 99%, 36%)">1</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">32</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">3</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">1</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        self</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">conv2 </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> nn</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">Conv2d</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token number" style="color:hsl(35, 99%, 36%)">32</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">64</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">3</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">1</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        self</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">dropout1 </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> nn</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">Dropout</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token number" style="color:hsl(35, 99%, 36%)">0.25</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        self</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">dropout2 </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> nn</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">Dropout</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token number" style="color:hsl(35, 99%, 36%)">0.5</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        self</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">fc1 </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> nn</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">Linear</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token number" style="color:hsl(35, 99%, 36%)">9216</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">128</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        self</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">fc2 </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> nn</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">Linear</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token number" style="color:hsl(35, 99%, 36%)">128</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">10</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">def</span><span class="token plain"> </span><span class="token function" style="color:hsl(221, 87%, 60%)">forward</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">self</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> x</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        x </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">conv1</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">x</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        x </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> F</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">relu</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">x</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        x </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">conv2</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">x</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        x </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> F</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">relu</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">x</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        x </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> F</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">max_pool2d</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">x</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">2</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        x </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">dropout1</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">x</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        x </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">flatten</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">x</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">1</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        x </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">fc1</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">x</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        x </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> F</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">relu</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">x</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        x </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">dropout2</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">x</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        x </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> self</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">fc2</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">x</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        output </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> F</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">log_softmax</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">x</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> dim</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token number" style="color:hsl(35, 99%, 36%)">1</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">return</span><span class="token plain"> output</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">def</span><span class="token plain"> </span><span class="token function" style="color:hsl(221, 87%, 60%)">train</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">args</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> model</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> device</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> train_loader</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> optimizer</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> epoch</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    model</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">train</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">for</span><span class="token plain"> batch_idx</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">data</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> target</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">in</span><span class="token plain"> </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">enumerate</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">train_loader</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        data</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> target </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> data</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">to</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">device</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> target</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">to</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">device</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        optimizer</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">zero_grad</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        output </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> model</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">data</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        loss </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> F</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">nll_loss</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">output</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> target</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        loss</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">backward</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        optimizer</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">step</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">if</span><span class="token plain"> batch_idx </span><span class="token operator" style="color:hsl(221, 87%, 60%)">%</span><span class="token plain"> args</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">log_interval </span><span class="token operator" style="color:hsl(221, 87%, 60%)">==</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">0</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">print</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;Train Epoch: {} [{}/{} ({:.0f}%)]\tLoss: {:.6f}&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token builtin" style="color:hsl(119, 34%, 47%)">format</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                epoch</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> batch_idx </span><span class="token operator" style="color:hsl(221, 87%, 60%)">*</span><span class="token plain"> </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">len</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">data</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">len</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">train_loader</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">dataset</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                </span><span class="token number" style="color:hsl(35, 99%, 36%)">100.</span><span class="token plain"> </span><span class="token operator" style="color:hsl(221, 87%, 60%)">*</span><span class="token plain"> batch_idx </span><span class="token operator" style="color:hsl(221, 87%, 60%)">/</span><span class="token plain"> </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">len</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">train_loader</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> loss</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">item</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">if</span><span class="token plain"> args</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">dry_run</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">break</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">def</span><span class="token plain"> </span><span class="token function" style="color:hsl(221, 87%, 60%)">test</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">model</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> device</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> test_loader</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    model</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token builtin" style="color:hsl(119, 34%, 47%)">eval</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    test_loss </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    correct </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">with</span><span class="token plain"> torch</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">no_grad</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">for</span><span class="token plain"> data</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> target </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">in</span><span class="token plain"> test_loader</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            data</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> target </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> data</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">to</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">device</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> target</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">to</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">device</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            output </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> model</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">data</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            test_loss </span><span class="token operator" style="color:hsl(221, 87%, 60%)">+=</span><span class="token plain"> F</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">nll_loss</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">output</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> target</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> reduction</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;sum&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">item</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain">  </span><span class="token comment" style="color:hsl(230, 4%, 64%)"># sum up batch loss</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            pred </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> output</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">argmax</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">dim</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token number" style="color:hsl(35, 99%, 36%)">1</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> keepdim</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token boolean" style="color:hsl(35, 99%, 36%)">True</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain">  </span><span class="token comment" style="color:hsl(230, 4%, 64%)"># get the index of the max log-probability</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">            correct </span><span class="token operator" style="color:hsl(221, 87%, 60%)">+=</span><span class="token plain"> pred</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">eq</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">target</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">view_as</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">pred</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token builtin" style="color:hsl(119, 34%, 47%)">sum</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">item</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    test_loss </span><span class="token operator" style="color:hsl(221, 87%, 60%)">/=</span><span class="token plain"> </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">len</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">test_loader</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">dataset</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">print</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;\nTest set: Average loss: {:.4f}, Accuracy: {}/{} ({:.0f}%)\n&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token builtin" style="color:hsl(119, 34%, 47%)">format</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        test_loss</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> correct</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">len</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">test_loader</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">dataset</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        </span><span class="token number" style="color:hsl(35, 99%, 36%)">100.</span><span class="token plain"> </span><span class="token operator" style="color:hsl(221, 87%, 60%)">*</span><span class="token plain"> correct </span><span class="token operator" style="color:hsl(221, 87%, 60%)">/</span><span class="token plain"> </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">len</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">test_loader</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">dataset</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">def</span><span class="token plain"> </span><span class="token function" style="color:hsl(221, 87%, 60%)">setup</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">rank</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> world_size</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token comment" style="color:hsl(230, 4%, 64%)"># initialize the process group</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    dist</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">init_process_group</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;nccl&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> rank</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain">rank</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> world_size</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain">world_size</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">def</span><span class="token plain"> </span><span class="token function" style="color:hsl(221, 87%, 60%)">main</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token comment" style="color:hsl(230, 4%, 64%)"># Training settings</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    parser </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> argparse</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">ArgumentParser</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">description</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;PyTorch MNIST Example&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    parser</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">add_argument</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;--batch-size&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">type</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token builtin" style="color:hsl(119, 34%, 47%)">int</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> default</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token number" style="color:hsl(35, 99%, 36%)">64</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> metavar</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;N&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                        </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">help</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;input batch size for training (default: 64)&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    parser</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">add_argument</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;--test-batch-size&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">type</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token builtin" style="color:hsl(119, 34%, 47%)">int</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> default</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token number" style="color:hsl(35, 99%, 36%)">1000</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> metavar</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;N&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                        </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">help</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;input batch size for testing (default: 1000)&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    parser</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">add_argument</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;--epochs&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">type</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token builtin" style="color:hsl(119, 34%, 47%)">int</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> default</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token number" style="color:hsl(35, 99%, 36%)">14</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> metavar</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;N&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                        </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">help</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;number of epochs to train (default: 14)&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    parser</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">add_argument</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;--lr&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">type</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token builtin" style="color:hsl(119, 34%, 47%)">float</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> default</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token number" style="color:hsl(35, 99%, 36%)">1.0</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> metavar</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;LR&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                        </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">help</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;learning rate (default: 1.0)&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    parser</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">add_argument</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;--gamma&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">type</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token builtin" style="color:hsl(119, 34%, 47%)">float</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> default</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token number" style="color:hsl(35, 99%, 36%)">0.7</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> metavar</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;M&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                        </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">help</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;Learning rate step gamma (default: 0.7)&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    parser</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">add_argument</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;--no-cuda&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> action</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;store_true&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> default</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token boolean" style="color:hsl(35, 99%, 36%)">False</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                        </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">help</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;disables CUDA training&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    parser</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">add_argument</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;--dry-run&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> action</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;store_true&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> default</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token boolean" style="color:hsl(35, 99%, 36%)">False</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                        </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">help</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;quickly check a single pass&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    parser</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">add_argument</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;--seed&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">type</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token builtin" style="color:hsl(119, 34%, 47%)">int</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> default</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token number" style="color:hsl(35, 99%, 36%)">1</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> metavar</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;S&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                        </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">help</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;random seed (default: 1)&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    parser</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">add_argument</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;--log-interval&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">type</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token builtin" style="color:hsl(119, 34%, 47%)">int</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> default</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token number" style="color:hsl(35, 99%, 36%)">10</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> metavar</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;N&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                        </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">help</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;how many batches to wait before logging training status&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    parser</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">add_argument</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;--save-model&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> action</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;store_true&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> default</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token boolean" style="color:hsl(35, 99%, 36%)">False</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                        </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">help</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;For Saving the current Model&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    args </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> parser</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">parse_args</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    use_cuda </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">not</span><span class="token plain"> args</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">no_cuda </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">and</span><span class="token plain"> torch</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">cuda</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">is_available</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    torch</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">manual_seed</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">args</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">seed</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    train_kwargs </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">{</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;batch_size&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"> args</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">batch_size</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    test_kwargs </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">{</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;batch_size&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"> args</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">test_batch_size</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">if</span><span class="token plain"> use_cuda</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        cuda_kwargs </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">{</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;num_workers&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"> </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">int</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">os</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;SLURM_CPUS_PER_TASK&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                       </span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;pin_memory&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"> </span><span class="token boolean" style="color:hsl(35, 99%, 36%)">True</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                       </span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;shuffle&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"> </span><span class="token boolean" style="color:hsl(35, 99%, 36%)">True</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        train_kwargs</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">update</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">cuda_kwargs</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        test_kwargs</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">update</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">cuda_kwargs</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    transform</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain">transforms</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">Compose</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        transforms</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">ToTensor</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        transforms</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">Normalize</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token number" style="color:hsl(35, 99%, 36%)">0.1307</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token number" style="color:hsl(35, 99%, 36%)">0.3081</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        </span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    dataset1 </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> datasets</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">MNIST</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;data&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> train</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token boolean" style="color:hsl(35, 99%, 36%)">True</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> download</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token boolean" style="color:hsl(35, 99%, 36%)">False</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                       transform</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain">transform</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    dataset2 </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> datasets</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">MNIST</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;data&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> train</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token boolean" style="color:hsl(35, 99%, 36%)">False</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                       transform</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain">transform</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"> </span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    world_size    </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">int</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">os</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;WORLD_SIZE&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    rank          </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">int</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">os</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;SLURM_PROCID&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    gpus_per_node </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">int</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">os</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;SLURM_GPUS_ON_NODE&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">assert</span><span class="token plain"> gpus_per_node </span><span class="token operator" style="color:hsl(221, 87%, 60%)">==</span><span class="token plain"> torch</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">cuda</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">device_count</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">print</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">f&quot;Hello from rank </span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">{</span><span class="token string-interpolation interpolation">rank</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">}</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)"> of </span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">{</span><span class="token string-interpolation interpolation">world_size</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">}</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)"> on </span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">{</span><span class="token string-interpolation interpolation">gethostname</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">}</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)"> where there are&quot;</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">          </span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">f&quot; </span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">{</span><span class="token string-interpolation interpolation">gpus_per_node</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">}</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)"> allocated GPUs per node.&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> flush</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token boolean" style="color:hsl(35, 99%, 36%)">True</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    setup</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">rank</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> world_size</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">if</span><span class="token plain"> rank </span><span class="token operator" style="color:hsl(221, 87%, 60%)">==</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">0</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"> </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">print</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">f&quot;Group initialized? </span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">{</span><span class="token string-interpolation interpolation">dist</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token string-interpolation interpolation">is_initialized</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">}</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> flush</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token boolean" style="color:hsl(35, 99%, 36%)">True</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    local_rank </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> rank </span><span class="token operator" style="color:hsl(221, 87%, 60%)">-</span><span class="token plain"> gpus_per_node </span><span class="token operator" style="color:hsl(221, 87%, 60%)">*</span><span class="token plain"> </span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">rank </span><span class="token operator" style="color:hsl(221, 87%, 60%)">//</span><span class="token plain"> gpus_per_node</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    torch</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">cuda</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">set_device</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">local_rank</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">print</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">f&quot;host: </span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">{</span><span class="token string-interpolation interpolation">gethostname</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">}</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">, rank: </span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">{</span><span class="token string-interpolation interpolation">rank</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">}</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">, local_rank: </span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">{</span><span class="token string-interpolation interpolation">local_rank</span><span class="token string-interpolation interpolation punctuation" style="color:hsl(119, 34%, 47%)">}</span><span class="token string-interpolation string" style="color:hsl(119, 34%, 47%)">&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    train_sampler </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">utils</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">data</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">distributed</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">DistributedSampler</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">dataset1</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> num_replicas</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain">world_size</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> rank</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain">rank</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    train_loader </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">utils</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">data</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">DataLoader</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">dataset1</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> batch_size</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain">args</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">batch_size</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> sampler</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain">train_sampler</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                                               num_workers</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token builtin" style="color:hsl(119, 34%, 47%)">int</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">os</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">environ</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;SLURM_CPUS_PER_TASK&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> pin_memory</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token boolean" style="color:hsl(35, 99%, 36%)">True</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    test_loader </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> torch</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">utils</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">data</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">DataLoader</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">dataset2</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token operator" style="color:hsl(221, 87%, 60%)">**</span><span class="token plain">test_kwargs</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    model </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> Net</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">to</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">local_rank</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    ddp_model </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> DDP</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">model</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> device_ids</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token plain">local_rank</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    optimizer </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> optim</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">Adadelta</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">ddp_model</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">parameters</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> lr</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain">args</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">lr</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    scheduler </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> StepLR</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">optimizer</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> step_size</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token number" style="color:hsl(35, 99%, 36%)">1</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> gamma</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain">args</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">gamma</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">for</span><span class="token plain"> epoch </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">in</span><span class="token plain"> </span><span class="token builtin" style="color:hsl(119, 34%, 47%)">range</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token number" style="color:hsl(35, 99%, 36%)">1</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> args</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">epochs </span><span class="token operator" style="color:hsl(221, 87%, 60%)">+</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">1</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        train</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">args</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> ddp_model</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> local_rank</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> train_loader</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> optimizer</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> epoch</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">if</span><span class="token plain"> rank </span><span class="token operator" style="color:hsl(221, 87%, 60%)">==</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">0</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"> test</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">ddp_model</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> local_rank</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> test_loader</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        scheduler</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">step</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">if</span><span class="token plain"> args</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">save_model </span><span class="token keyword" style="color:hsl(301, 63%, 40%)">and</span><span class="token plain"> rank </span><span class="token operator" style="color:hsl(221, 87%, 60%)">==</span><span class="token plain"> </span><span class="token number" style="color:hsl(35, 99%, 36%)">0</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">        torch</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">save</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">model</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">state_dict</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;mnist_cnn.pt&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    dist</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">destroy_process_group</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">if</span><span class="token plain"> __name__ </span><span class="token operator" style="color:hsl(221, 87%, 60%)">==</span><span class="token plain"> </span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;__main__&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">    main</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><br></span></code></pre></div></div>
<p>In the script above the number of workers is taken directly from the value of <code>--cpus-per-task</code> which is set in the Slurm script:</p>
<div class="language-text codeBlockContainer_Gtvh theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_q3dc"><pre tabindex="0" class="prism-code language-text codeBlock_ggay thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_Y19p"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">cuda_kwargs = {&#x27;num_workers&#x27;: int(os.environ[&quot;SLURM_CPUS_PER_TASK&quot;]), &#x27;pin_memory&#x27;: True, &#x27;shuffle&#x27;: True}</span><br></span></code></pre></div></div>
<p>It also relies on the script <a href="https://github.com/PrincetonUniversity/multi_gpu_training/blob/main/01_single_gpu/download_data.py" target="_blank" rel="noopener noreferrer">download_data.py</a>:</p>
<div class="language-python codeBlockContainer_Gtvh theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_q3dc"><pre tabindex="0" class="prism-code language-python codeBlock_ggay thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_Y19p"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token keyword" style="color:hsl(301, 63%, 40%)">import</span><span class="token plain"> torchvision</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token keyword" style="color:hsl(301, 63%, 40%)">import</span><span class="token plain"> warnings</span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">warnings</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">simplefilter</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token string" style="color:hsl(119, 34%, 47%)">&quot;ignore&quot;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain"></span><span class="token comment" style="color:hsl(230, 4%, 64%)"># compute nodes do not have internet so download the data in advance</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">_ </span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token plain"> torchvision</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">datasets</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">.</span><span class="token plain">MNIST</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">(</span><span class="token plain">root</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token string" style="color:hsl(119, 34%, 47%)">&#x27;data&#x27;</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                               train</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token boolean" style="color:hsl(35, 99%, 36%)">True</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                               transform</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token boolean" style="color:hsl(35, 99%, 36%)">None</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                               target_transform</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token boolean" style="color:hsl(35, 99%, 36%)">None</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token plain">                               download</span><span class="token operator" style="color:hsl(221, 87%, 60%)">=</span><span class="token boolean" style="color:hsl(35, 99%, 36%)">True</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">)</span><br></span></code></pre></div></div>
<p>Execute the commands below to run the example above:</p>
<div class="language-bash codeBlockContainer_Gtvh theme-code-block" style="--prism-background-color:hsl(230, 1%, 98%);--prism-color:hsl(230, 8%, 24%)"><div class="codeBlockContent_q3dc"><pre tabindex="0" class="prism-code language-bash codeBlock_ggay thin-scrollbar" style="background-color:hsl(230, 1%, 98%);color:hsl(230, 8%, 24%)"><code class="codeBlockLines_Y19p"><span class="token-line" style="color:hsl(230, 8%, 24%)"><span class="token punctuation" style="color:hsl(119, 34%, 47%)">[</span><span class="token plain">NetID@log-1 full-ddp-test</span><span class="token punctuation" style="color:hsl(119, 34%, 47%)">]</span><span class="token plain">$ sbatch run-full.SBATCH</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_nzaP" id="memory-issues">Memory issues<a href="#memory-issues" class="hash-link" aria-label="Direct link to Memory issues" title="Direct link to Memory issues" translate="no">​</a></h2>
<p>Use <code>gradient_as_bucket_view=True</code> when making the DDP model to decrease the required memory by 1/3.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/NYU-RTS/rts-docs/blob/main/docs/hpc/08_ml_ai_hpc/03_pytorch_on_hpc_mulit_gpu.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_liBE" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_si7g"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/pr-preview/pr-193/docs/hpc/ml_ai_hpc/pytorch_intro/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Machine Learning on HPC</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/pr-preview/pr-193/docs/hpc/ml_ai_hpc/run_hf_model/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Run a Hugging Face model</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_CFJu thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overall-idea-of-distributed-data-parallel" class="table-of-contents__link toc-highlight">Overall Idea of Distributed Data Parallel</a></li><li><a href="#main-changes-needed-in-going-from-single-gpu-to-multi-gpu-training-with-ddp" class="table-of-contents__link toc-highlight">Main changes needed in going from single-GPU to multi-GPU training with DDP</a></li><li><a href="#simple-ddp-script" class="table-of-contents__link toc-highlight">Simple DDP Script</a><ul><li><a href="#job-arrays" class="table-of-contents__link toc-highlight">Job Arrays</a></li><li><a href="#--ntasks-per-node-versus---ntasks" class="table-of-contents__link toc-highlight">--ntasks-per-node versus --ntasks</a></li></ul></li><li><a href="#what-is-local_rank" class="table-of-contents__link toc-highlight">What is <code>local_rank</code>?</a></li><li><a href="#total-number-of-tasks-equals-total-number-of-gpus" class="table-of-contents__link toc-highlight">Total number of tasks equals total number of GPUs</a></li><li><a href="#full-example-of-ddp" class="table-of-contents__link toc-highlight">Full Example of DDP</a></li><li><a href="#memory-issues" class="table-of-contents__link toc-highlight">Memory issues</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Contact</div><ul class="footer__items clean-list"><li class="footer__item"><a href="mailto:hpc@nyu.edu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Email HPC support<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_i9eD"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="mailto:hsrn-support@nyu.edu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Email HSRN support<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_i9eD"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="mailto:research-cloud-support@nyu.edu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Email Research Cloud support<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_i9eD"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="mailto:srde-support@nyu.edu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Email Secure Research Data Environment support<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_i9eD"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="mailto:genai-support@nyu.edu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Email general GenAI support<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_i9eD"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="mailto:genai-research-support@nyu.edu" target="_blank" rel="noopener noreferrer" class="footer__link-item">Email GenAI for research support<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_i9eD"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Links</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://guides.nyu.edu/" target="_blank" rel="noopener noreferrer" class="footer__link-item">NYU Libraries Research Guides<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_i9eD"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://sites.google.com/nyu.edu/forc-camp/home" target="_blank" rel="noopener noreferrer" class="footer__link-item">FORC camp<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_i9eD"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://docs.google.com/forms/d/e/1FAIpQLSeHnmkPdR_IvWnT6a7U_V3RpfmQrpS8hjxI11FNnsZMlrBa4g/viewform" target="_blank" rel="noopener noreferrer" class="footer__link-item">Feedback</a></li><li class="footer__item"><a class="footer__link-item" href="/pr-preview/pr-193/blog/">Announcements</a></li><li class="footer__item"><a href="https://github.com/NYU-RTS/rts-docs" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_i9eD"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Made with 💜 in NYC!</div></div></div></footer></div>
</body>
</html>