# Sharing Data on HPC

## Introduction
To share files on the cluster with other users, we recommend using NFSv4 Access Control Lists (ACL) for a user to share access to their data with others. NFSv4 ACL mechanism allows for fine-grained control access to any files by any users or groups of users.
:::warning
We discourage users from setting `777` permissions with `chmod`, because this can lead to data loss (by a malicious user or unintentionally, by accident).
:::
:::info
Torch supports NFSv4 ACLs rather than the POSIX ACLs supported by Greene! NFSv4 ACLs allow for more fine grained control when compared to POSIX ACLs.
:::

### Anatomy of an Access Control Entry
An Access Control List is composed of Access Control Entries, each of which has the following structure:
```
[type]:[flags]:[principal]:[permissions]
```

| Property | Description |
| :------- | :---------- |
| *type*   | Kind of ACE entry, we recommend only using A (access). Deny type entries make the ACE more complex to reason about when compared to using only access type entries for the same configuration. |
| *flags*  | Inheritance flags which apply to directories and control how ACEs are inherited:<br/>- **`f`**: files inherit ACEs, but inheritance flags are not set on the files<br/>- **`d`**: directories inherit both the ACE and the inheritance flags<br/>- **`i`**: only inherit the inheritance flags, ACEs do not apply to this directory<br/>- **`n`**: directories only inherit ACEs, not the inheritance flags<br/>- **`g`**: only used when the principal is a group |
| *principal* | The user (identified by `NetID`) or group to apply the ACE to, with the following special principals:<br/>- **`OWNER`**<br/>- **`GROUP`**<br/>- **`EVERYONE`** |
| *permissions* | The level of access to grant. Aliases for most common uses include: the full set of permission entry types are listed below for reference, with the most commonly used options being:<br/>- **`R`**: Read, alias for `rntcy`<br/>- **`W`**: Write, alias for `watTNcCy`<br/>- **`X`**: Execute, alias for `watTNcCy` <br/> The full list of available options can be found [here](https://man7.org/linux/man-pages/man5/nfs4_acl.5.html).|


### Creating and Applying ACLs
The following commands are available:
-   `nfs4_setfacl` to set ACEs
-   `nfs4_editfacl` to edit ACEs
-   `nfs4_getfacl` to view ACLs
with the usage described in the following examples.

#### Give someone access to read a particular file
Append the ACL for that file by adding an ACE via 
```sh
nfs4_setfacl -a "A::NetID:R" filename
```
where the `-a` flag signifies "append". Since inheritance flags are only applicable to directories and the principal is not a group, no flags are needed.

#### Show current access properties

Create an empty file and view the default ACEs it:
```sh
~> touch temp
~> nfs4_getfacl temp 
# file: temp
A::OWNER@:rwatTnNcy
A:g:GROUP@:rtncy
A::EVERYONE@:rtncy
``` 
View changes after granting a collaborator read permissions:
```sh
~> nfs4_setfacl -a "A::collaborator-netid:R" temp 
~> nfs4_getfacl temp
# file: temp
A::collaborator-netid@hpc.nyu.edu:rtncy
A::OWNER@:rwatTnNcy
A:g:GROUP@:rtncy
A::EVERYONE@:rtncy
```
where `collaborator-netid` refers to the `NetID` of your collaborator.

## Linux Groups for Group Permissions
The HPC team allows teams to manage group membership using a IPA Linux Group. This is a good choice for when all users need the same read/write/execute permissions for a directory and subdirectories.

Please email hpc@nyu.edu if your team would like to use a Linux Group. Generally this will follow some kind of naming convention along the lines of:

g-DEPT-LABNAME

Once you have a group assigned, managers of the group can use the `ipa` commands to manage members via the login nodes.

Relevant user commands include:
- `ipa group-add-member`: Add members to a group.
Example:
`ipa group-add-member GROUP-NAME --users='NETID'`
- `ipa group-add-member-manager`: Add users that can manage members of this group.
Example:
`ipa group-add-member-manager GROUP-NAME --users='NETID'`
- `ipa group-find`: Search for groups.
Example:
```
ipa group-find test
----------------
2 groups matched
----------------
  Group name: g-test-2222
  GID: 891200121

  Group name: g-test-2223
  Description: g-test-2223
  GID: 891200122
----------------------------
Number of entries returned 2
----------------------------
```
- `ipa group-remove-member`: Remove members from a group.
Example:
`ipa group-remove-member --users=NETID`
- `ipa group-remove-member-manager`: Remove users that can manage members of this group.
Example:
`ipa group-remove-member-manager --users=NETID`
- `ipa group-show`: Display information about a named group.
Example:
`ipa group-show GROUP-NAME`
Example:
```
[mdw303@torch-login-1 ~]$ ipa group-show g-hpc-mdw303test
  Group name: g-hpc-mdw303test
  Description: test RPS group directory
  GID: 891200193
  Member users: mdw303, sw77
  Membership managed by users: mdw303
```
